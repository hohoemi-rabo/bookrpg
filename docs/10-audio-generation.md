# 10. 音声生成機能（TTS + BGM合成）

**Status**: TODO
**Priority**: 最優先
**Depends on**: 09-story-generation

## 概要

Gemini 2.5 TTSによる音声生成とBGMとの合成処理。

## 関連する要件

- 4.4 音声生成機能（REQUIREMENTS.md）
- 4.6 音声ファイル保存（REQUIREMENTS.md）

## Tasks

### TTS生成
- [ ] Gemini 2.5 TTS APIの実装
- [ ] ナレーション音声の生成
- [ ] 章ごとの音声ファイル生成

### BGM合成
- [ ] 音声ファイルとBGMの合成処理
- [ ] BGM音量の調整（ナレーションが聴きやすいバランス）
- [ ] ffmpegまたは類似ライブラリの導入

### ストレージ
- [ ] Cloudflare R2への音声ファイル保存
- [ ] 有料購入章 → 無期限保存
- [ ] 無料章 → 7日間保存（TTL設定）
- [ ] 署名付きURL生成（セキュアなアクセス）

### 非同期処理
- [ ] Cloudflare Queuesでの音声生成処理
- [ ] 生成状況の更新
- [ ] 生成完了通知

### 生成中UX
- [ ] プログレスバー表示
- [ ] 「冒険の準備中...」等のRPG風演出
- [ ] 「ブラウザを閉じないでください」注意書き

### エラーハンドリング
- [ ] 自動リトライ（最大3回）
- [ ] 失敗時の手動再生成ボタン
- [ ] エラーログの保存

### API
- [ ] GET /api/chapters/[id]/audio（音声ファイル取得）

## ファイル構成

```
src/
├── lib/
│   ├── gemini/
│   │   └── tts.ts
│   └── audio/
│       └── mixer.ts
└── workers/
    └── audio-queue.ts
```

## 完了条件

- ナレーション音声が生成される
- BGMと合成された音声が生成される
- R2に音声ファイルが保存される
- 生成中のプログレスが表示される
