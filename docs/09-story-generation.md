# 09. ストーリー生成機能

**Status**: TODO
**Priority**: 最優先
**Depends on**: 07-ai-summary, 08-world-bgm-selection

## 概要

Gemini 2.5を使用したRPG風ストーリーの生成機能。

## 関連する要件

- 4.3 ストーリー変換機能（REQUIREMENTS.md）

## Tasks

### ストーリー変換ルール実装
- [ ] 変換ルールのプロンプト設計
  - 主人公 → ユーザー（二人称視点）
  - 教え・知識 → 魔法 / スキル
  - 課題・問題 → モンスター / 試練
  - 解決策 → 必殺技 / 選択
- [ ] 世界観別のプロンプト調整

### 生成パターンA: 本全体を1ストーリー
- [ ] 約10分の音声尺に相当するテキスト生成
- [ ] 本の主要な教えを1つの物語にまとめる

### 生成パターンB: 章ごとに分割
- [ ] 本の構成を推測して5章程度に分割
- [ ] 1章あたり約2分の尺
- [ ] 各章の終わりは「次が気になる引き」

### 非同期処理
- [ ] Cloudflare Queuesでの非同期生成
- [ ] 生成状況の保存（questsテーブルのstatus）
- [ ] 生成完了通知

### API
- [ ] POST /api/quests（クエスト生成開始）
- [ ] GET /api/quests/[id]/status（生成状況確認）

## プロンプト設計

```
あなたはRPG風の物語を作成するナレーターです。
以下の本の内容を、冒険物語に変換してください。

【変換ルール】
- 主人公は「あなた」として二人称で語る
- 本の教えは「魔法」や「スキル」として表現
- 課題や問題は「モンスター」や「試練」として表現
- 解決策は「必殺技」や「選択」として表現

【世界観】{world_type}
【本の概要】{ai_summary}

【出力形式】
- 章タイトル
- ナレーション用テキスト
- 各章約2分の尺（約400-500文字）
```

## ファイル構成

```
src/
├── lib/
│   └── gemini/
│       └── story-generator.ts
└── workers/
    └── story-queue.ts
```

## 完了条件

- 本の内容がRPG風ストーリーに変換される
- 世界観に応じたストーリーが生成される
- 非同期で生成が完了する
