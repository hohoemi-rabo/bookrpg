---
paths:
  - "src/lib/gemini/**/*"
  - "src/workers/**/*"
---

# AI Integration Rules (Gemini 2.5)

## 使用するAPI

- **テキスト生成**: Gemini 2.5 Pro
- **TTS（音声合成）**: Gemini 2.5 TTS
- **画像/PDF読み取り**: Gemini 2.5 Vision

## ストーリー変換ルール

本の内容をRPG風に変換する際のルール:

| 原作要素   | RPG変換後              |
| ---------- | ---------------------- |
| 主人公     | ユーザー（二人称視点） |
| 教え・知識 | 魔法 / スキル          |
| 課題・問題 | モンスター / 試練      |
| 解決策     | 必殺技 / 選択          |

## プロンプト設計の原則

1. **役割を明確に**: 「あなたはRPG風の物語を作成するナレーターです」
2. **変換ルールを具体的に**: 上記の対応表を含める
3. **出力形式を指定**: 章タイトル、ナレーションテキスト、尺の目安
4. **世界観を反映**: ファンタジー/SF/学園ドラマに応じた表現

## 世界観別の調整

| 世界観       | 舞台設定       | 表現スタイル         |
| ------------ | -------------- | -------------------- |
| ファンタジー | 剣と魔法の世界 | 古風、壮大           |
| SF           | 宇宙・未来都市 | テクノロジー、論理的 |
| 学園ドラマ   | 学校・部活     | 青春、日常的         |

## 非同期処理

- Cloudflare Queuesで長時間処理を非同期化
- 生成状況をDBに保存し、ポーリングで確認

```tsx
// 生成開始
await queue.send({ type: 'generate_story', questId })

// ステータス確認
const { status } = await supabase
  .from('quests')
  .select('status')
  .eq('id', questId)
  .single()
```

## エラーハンドリング

- 自動リトライ（最大3回、指数バックオフ）
- 失敗時はエラーログを保存
- ユーザーには「手動再生成」ボタンを表示

## 音声合成（TTS）

- ナレーション音声を生成
- BGMと合成して1ファイルに
- 保存先: Cloudflare R2
